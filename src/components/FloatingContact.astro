---
import type { Lang } from "@/i18n";
import { t } from "@/i18n";
import { site, phoneHref, whatsappHref } from "@/lib/site";

const { lang } = Astro.props as { lang: Lang };

// ✅ doğru alanlar
const instagram = site.instagram;
const tiktok = site.tiktok;
const maps = site.mapsUrl;
const phone = phoneHref(site.phoneLocal);

// ✅ WhatsApp (site.ts içinden gelir)
const whatsapp = site.whatsappE164
  ? whatsappHref(site.whatsappE164, "Merhaba, rezervasyon hakkında bilgi alabilir miyim?")
  : null;
---

<div id="floatingContact" class="fixed z-[60] right-4 bottom-4 select-none">
  <!-- Panel (ikonların olduğu kısım) -->
  <div
    id="fcPanel"
    class="pointer-events-none opacity-0 translate-y-2 transition duration-200
           absolute bottom-[68px] right-0 w-[240px] overflow-hidden rounded-3xl
           bg-white shadow-2xl ring-1 ring-black/10"
    aria-hidden="true"
  >
    <div class="p-4">
      <div class="text-sm font-medium">Bize ulaşın</div>
      <div class="mt-1 text-xs text-muted">{site.address}</div>

      <!-- ✅ 4 ikon: Instagram / TikTok / Maps / WhatsApp -->
      <div class="mt-4 grid grid-cols-4 gap-3">
        <a
          class="grid place-items-center rounded-2xl bg-black/5 p-3 hover:bg-black/10 transition"
          href={instagram}
          target="_blank"
          rel="noreferrer"
          aria-label="Instagram"
          title="Instagram"
        >
          <!-- Instagram icon -->
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5Z" stroke="currentColor" stroke-width="1.8"/>
            <path d="M12 16a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z" stroke="currentColor" stroke-width="1.8"/>
            <path d="M17.5 6.5h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
          </svg>
        </a>

        <a
          class="grid place-items-center rounded-2xl bg-black/5 p-3 hover:bg-black/10 transition"
          href={tiktok}
          target="_blank"
          rel="noreferrer"
          aria-label="TikTok"
          title="TikTok"
        >
          <!-- TikTok-like icon (simple) -->
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <path
              d="M14 3v11.5a3.5 3.5 0 1 1-3-3.46"
              stroke="currentColor"
              stroke-width="1.8"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
            <path
              d="M14 7.2c1.1 1.6 2.7 2.7 5 2.8"
              stroke="currentColor"
              stroke-width="1.8"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
        </a>

        <a
          class="grid place-items-center rounded-2xl bg-black/5 p-3 hover:bg-black/10 transition"
          href={maps}
          target="_blank"
          rel="noreferrer"
          aria-label="Google Maps"
          title="Google Maps"
        >
          <!-- Map pin icon -->
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <path
              d="M12 21s7-4.5 7-11a7 7 0 1 0-14 0c0 6.5 7 11 7 11Z"
              stroke="currentColor"
              stroke-width="1.8"
              stroke-linejoin="round"
            />
            <path
              d="M12 12.5a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z"
              stroke="currentColor"
              stroke-width="1.8"
            />
          </svg>
        </a>

        <!-- ✅ WhatsApp sadece numara varsa göster -->
        {whatsapp ? (
          <a
            class="grid place-items-center rounded-2xl bg-black/5 p-3 hover:bg-black/10 transition"
            href={whatsapp}
            target="_blank"
            rel="noreferrer"
            aria-label="WhatsApp"
            title="WhatsApp"
          >
            <!-- WhatsApp icon -->
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
              <path
                d="M20.3 11.9a8.3 8.3 0 0 1-12.3 7.2L4 20l1-3.8a8.3 8.3 0 1 1 15.3-4.3Z"
                stroke="currentColor"
                stroke-width="1.8"
                stroke-linejoin="round"
              />
              <path
                d="M9.2 9.6c.2-.4.4-.5.7-.5h.5c.2 0 .4.1.5.4l.6 1.4c.1.2.1.5-.1.7l-.4.5c.4.8 1.1 1.5 1.9 1.9l.5-.4c.2-.2.5-.2.7-.1l1.4.6c.3.1.4.3.4.5v.5c0 .3-.1.5-.5.7-.6.3-1.8.2-3.3-.5-1.5-.7-2.9-2.1-3.6-3.6-.7-1.5-.8-2.7-.5-3.3Z"
                stroke="currentColor"
                stroke-width="1.6"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
          </a>
        ) : (
          <div class="opacity-40 grid place-items-center rounded-2xl bg-black/5 p-3" title="WhatsApp kapalı">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
              <path
                d="M20.3 11.9a8.3 8.3 0 0 1-12.3 7.2L4 20l1-3.8a8.3 8.3 0 1 1 15.3-4.3Z"
                stroke="currentColor"
                stroke-width="1.8"
                stroke-linejoin="round"
              />
            </svg>
          </div>
        )}
      </div>

      <a
        href={phone}
        class="mt-4 inline-flex w-full items-center justify-center gap-2 rounded-2xl
               bg-brand px-4 py-3 text-sm font-semibold text-white shadow-ring hover:opacity-95"
      >
        <!-- Phone icon -->
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
          <path
            d="M22 16.9v3a2 2 0 0 1-2.2 2 19.8 19.8 0 0 1-8.6-3.1 19.5 19.5 0 0 1-6-6A19.8 19.8 0 0 1 2.1 4.2 2 2 0 0 1 4.1 2h3a2 2 0 0 1 2 1.7c.1.9.3 1.8.6 2.6a2 2 0 0 1-.5 2.1L8 10a16 16 0 0 0 6 6l1.6-1.2a2 2 0 0 1 2.1-.5c.8.3 1.7.5 2.6.6A2 2 0 0 1 22 16.9Z"
            stroke="currentColor"
            stroke-width="1.8"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
        {t(lang, "cta.call")}
      </a>
    </div>
  </div>

  <!-- Sürüklenebilir buton -->
  <button
    id="fcBtn"
    class="group relative grid h-14 w-14 place-items-center rounded-full bg-brand text-white shadow-2xl shadow-black/20
           ring-1 ring-black/10 hover:opacity-95 active:scale-[0.98] transition"
    aria-label="Bize ulaşın"
    type="button"
  >
    <!-- tooltip -->
    <span
      class="pointer-events-none absolute right-[68px] whitespace-nowrap rounded-2xl bg-black/80 px-3 py-1.5 text-xs
             text-white opacity-0 translate-x-2 transition duration-200 group-hover:opacity-100 group-hover:translate-x-0"
    >
      Bize ulaşın
    </span>

    <!-- phone icon -->
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
      <path
        d="M22 16.9v3a2 2 0 0 1-2.2 2 19.8 19.8 0 0 1-8.6-3.1 19.5 19.5 0 0 1-6-6A19.8 19.8 0 0 1 2.1 4.2 2 2 0 0 1 4.1 2h3a2 2 0 0 1 2 1.7c.1.9.3 1.8.6 2.6a2 2 0 0 1-.5 2.1L8 10a16 16 0 0 0 6 6l1.6-1.2a2 2 0 0 1 2.1-.5c.8.3 1.7.5 2.6.6A2 2 0 0 1 22 16.9Z"
        stroke="currentColor"
        stroke-width="1.8"
        stroke-linecap="round"
        stroke-linejoin="round"
      />
    </svg>
  </button>

  <script is:inline>
    (() => {
      const root = document.getElementById("floatingContact");
      const btn = document.getElementById("fcBtn");
      const panel = document.getElementById("fcPanel");
      if (!root || !btn || !panel) return;

      let open = false;
      const setOpen = (v) => {
        open = v;
        if (open) {
          panel.classList.remove("pointer-events-none", "opacity-0", "translate-y-2");
          panel.classList.add("pointer-events-auto", "opacity-100", "translate-y-0");
          panel.setAttribute("aria-hidden", "false");
        } else {
          panel.classList.add("pointer-events-none", "opacity-0", "translate-y-2");
          panel.classList.remove("pointer-events-auto", "opacity-100", "translate-y-0");
          panel.setAttribute("aria-hidden", "true");
        }
      };

      btn.addEventListener("click", () => setOpen(!open));
      document.addEventListener("click", (e) => {
        if (!root.contains(e.target)) setOpen(false);
      });

      // drag (touch + mouse)
      let dragging = false;
      let startX = 0, startY = 0;
      let startRight = 16, startBottom = 16;

      const getPos = () => {
        const r = parseFloat(root.style.right || "16");
        const b = parseFloat(root.style.bottom || "16");
        return { r, b };
      };

      const onDown = (clientX, clientY) => {
        dragging = true;
        const { r, b } = getPos();
        startRight = r; startBottom = b;
        startX = clientX; startY = clientY;
      };

      const onMove = (clientX, clientY) => {
        if (!dragging) return;
        const dx = clientX - startX;
        const dy = clientY - startY;

        let right = startRight - dx;
        let bottom = startBottom - dy;

        const pad = 8;
        const maxRight = window.innerWidth - 56 - pad;
        const maxBottom = window.innerHeight - 56 - pad;

        right = Math.max(pad, Math.min(maxRight, right));
        bottom = Math.max(pad, Math.min(maxBottom, bottom));

        root.style.right = right + "px";
        root.style.bottom = bottom + "px";
      };

      const onUp = () => { dragging = false; };

      btn.addEventListener("mousedown", (e) => onDown(e.clientX, e.clientY));
      window.addEventListener("mousemove", (e) => onMove(e.clientX, e.clientY));
      window.addEventListener("mouseup", onUp);

      btn.addEventListener("touchstart", (e) => {
        const t = e.touches[0];
        if (!t) return;
        onDown(t.clientX, t.clientY);
      }, { passive: true });

      window.addEventListener("touchmove", (e) => {
        const t = e.touches[0];
        if (!t) return;
        onMove(t.clientX, t.clientY);
      }, { passive: true });

      window.addEventListener("touchend", onUp);

      root.style.right = "16px";
      root.style.bottom = "16px";
    })();
  </script>
</div>
